# Интеграция с ЮКассой

## Настройка переменных окружения в Render

Для работы с реальным API ЮКассы необходимо добавить следующие переменные окружения в панели управления Render:

### Обязательные переменные:
- `YOOKASSA_SHOP_ID` - ID вашего магазина в ЮКассе
- `YOOKASSA_SECRET_KEY` - Секретный ключ магазина
- `YOOKASSA_WEBHOOK_URL` - URL для вебхуков (например: https://your-app.onrender.com)

### Дополнительные переменные:
- `JWT_SECRET` - Секретный ключ для JWT токенов
- `SUPABASE_URL` - URL вашей базы данных Supabase (если используется)
- `SUPABASE_ANON_KEY` - Анонимный ключ Supabase

## Настройка вебхуков в ЮКассе

1. Войдите в личный кабинет ЮКассы
2. Перейдите в раздел "Настройки" → "Вебхуки"
3. Добавьте новый вебхук со следующими параметрами:
   - **URL**: `https://your-app.onrender.com/api/payments/webhook`
   - **События**: `payment.succeeded`

## Процесс оплаты

### 1. Создание платежа
- Пользователь выбирает тариф (30 или 90 слотов)
- Сервер создает платеж в ЮКассе через API
- Пользователь перенаправляется на страницу оплаты ЮКассы

### 2. Обработка платежа
- После успешной оплаты ЮКасса отправляет вебхук на наш сервер
- Сервер обновляет статус платежа в базе данных
- Активируется подписка пользователя

### 3. Подтверждение оплаты
- Пользователь возвращается на сайт после оплаты
- Статус подписки автоматически обновляется

## API Endpoints

### Создание платежа
```http
POST /api/payments/create
Content-Type: application/json
Authorization: Bearer <jwt-token>

{
  "plan_type": "basic" | "premium"
}
```

### Вебхук для ЮКассы
```http
POST /api/payments/webhook
Content-Type: application/json

{
  "type": "notification",
  "event": "payment.succeeded",
  "object": {
    "id": "payment_id",
    "status": "succeeded",
    // ... другие данные платежа
  }
}
```

### Проверка статуса платежа
```http
GET /api/payments/:paymentId/status
Authorization: Bearer <jwt-token>
```

## Тестирование

### Тестовые данные ЮКассы
Для тестирования используйте следующие карты:

- **Успешная оплата**: 5555 5555 5555 4477
- **Недостаточно средств**: 5555 5555 5555 4495
- **Карта заблокирована**: 5555 5555 5555 4497

### Локальное тестирование
1. Установите переменные окружения в файле `.env`
2. Запустите сервер: `npm start`
3. Протестируйте создание платежа через Postman или UI приложения

## Безопасность

- Все платежи защищены JWT токенами
- Валидация данных на сервере
- Обработка ошибок и исключений
- Логирование всех операций

## Устранение неполадок

### Платеж не создается
- Проверьте корректность `YOOKASSA_SHOP_ID` и `YOOKASSA_SECRET_KEY`
- Убедитесь, что вебхук настроен правильно
- Проверьте логи сервера на наличие ошибок

### Вебхук не обрабатывается
- Убедитесь, что URL вебхука правильный
- Проверьте, что сервер доступен извне
- Проверьте логи для диагностики

### Статус платежа не обновляется
- Проверьте подключение к базе данных
- Убедитесь, что обработчик вебхука работает корректно
